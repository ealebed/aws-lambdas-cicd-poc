name: Go Lambda Deploy

on:
  workflow_call:
    inputs:
      lambda_path:
        required: true
        type: string
        description: 'Path to the Lambda function directory (e.g., lambdas/go/example-lambda)'
      lambda_name:
        required: true
        type: string
        description: 'Name of the Lambda function (folder name)'
      environment:
        required: true
        type: string
      region:
        required: false
        type: string
        description: "Deploy to this region only, or 'all' (default). Manual runs: validate against deploy.<env>.regions"
        default: 'all'
    secrets:
      AWS_ROLE_ARN:
        required: true

jobs:
  resolve-regions:
    name: Resolve deploy regions
    runs-on: ubuntu-latest
    timeout-minutes: 5
    environment: ${{ inputs.environment }}
    outputs:
      deploy_regions_json: ${{ steps.resolve.outputs.deploy_regions_json }}
      primary_region: ${{ steps.resolve.outputs.primary_region }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Parse config (regions for environment)
        id: parse
        run: |
          bash scripts/parse-lambda-config.sh "${{ inputs.lambda_path }}" "${{ inputs.lambda_name }}" "$GITHUB_OUTPUT" "${{ inputs.environment }}"

      - name: Resolve regions and validate manual region
        id: resolve
        env:
          REGIONS_JSON: ${{ steps.parse.outputs.regions_json }}
        run: |
          bash scripts/resolve-deploy-regions.sh "${{ inputs.region }}" "${{ vars.AWS_REGION }}" "${{ inputs.environment }}"

  build:
    name: Build Go Lambda - ${{ inputs.lambda_name }}
    runs-on: ubuntu-latest
    needs: resolve-regions
    timeout-minutes: 15
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    outputs:
      image_uri_primary: ${{ steps.image-uri.outputs.uri }}
      tag: ${{ steps.set-tag.outputs.TAG }}
      primary_region: ${{ needs.resolve-regions.outputs.primary_region }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Decide on tag
        id: set-tag
        run: |
          TIMESTAMP=$(date -u +'%Y.%m.%d-%H.%M')
          BRANCH="${{ github.event.inputs.branch || github.ref_name }}"
          [[ "${BRANCH}" == "master" ]] && echo "TAG=${TIMESTAMP}" >> $GITHUB_OUTPUT || echo "TAG=${TIMESTAMP}-SNAPSHOT" >> $GITHUB_OUTPUT

      - name: Login to AWS (primary region)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession-${{ inputs.environment }}-${{ inputs.lambda_name }}
          aws-region: ${{ needs.resolve-regions.outputs.primary_region }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine ECR repository
        id: ecr-repo
        run: |
          ECR_REPO="lambda-${{ inputs.lambda_name }}-${{ inputs.environment }}"
          REGISTRY="${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ needs.resolve-regions.outputs.primary_region }}.amazonaws.com"
          echo "repository=$ECR_REPO" >> $GITHUB_OUTPUT
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

      - name: Ensure ECR repository exists and set lifecycle policy
        run: |
          bash scripts/ecr-ensure-repo.sh ${{ steps.ecr-repo.outputs.repository }} ${{ needs.resolve-regions.outputs.primary_region }}

      - name: Login to Amazon ECR
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.ecr-repo.outputs.registry }}
          ecr: auto

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.0'

      - name: Determine Docker platform
        id: docker-platform
        run: |
          bash scripts/determine-docker-platform.sh "${{ inputs.lambda_path }}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.lambda_path }}
          file: lambdas/go/Dockerfile
          push: true
          platforms: ${{ steps.docker-platform.outputs.platform }}
          provenance: false
          sbom: false
          tags: |
            ${{ steps.ecr-repo.outputs.registry }}/${{ steps.ecr-repo.outputs.repository }}:${{ steps.set-tag.outputs.TAG }}
            ${{ steps.ecr-repo.outputs.registry }}/${{ steps.ecr-repo.outputs.repository }}:latest
          cache-from: type=registry,ref=${{ steps.ecr-repo.outputs.registry }}/${{ steps.ecr-repo.outputs.repository }}:buildcache
          cache-to: type=registry,ref=${{ steps.ecr-repo.outputs.registry }}/${{ steps.ecr-repo.outputs.repository }}:buildcache,mode=max

      - name: Capture image URI
        id: image-uri
        run: |
          echo "uri=${{ steps.ecr-repo.outputs.registry }}/${{ steps.ecr-repo.outputs.repository }}:${{ steps.set-tag.outputs.TAG }}" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to ${{ matrix.region }}
    runs-on: ubuntu-latest
    needs: [resolve-regions, build]
    timeout-minutes: 10
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        region: ${{ fromJson(needs.resolve-regions.outputs.deploy_regions_json) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Parse Lambda configuration
        id: lambda-config
        run: |
          bash scripts/parse-lambda-config.sh "${{ inputs.lambda_path }}" "${{ inputs.lambda_name }}"

      - name: Login to AWS
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSession-${{ inputs.environment }}-${{ inputs.lambda_name }}-${{ matrix.region }}
          aws-region: ${{ matrix.region }}

      - name: Ensure ECR repository exists and set lifecycle policy
        run: |
          bash scripts/ecr-ensure-repo.sh "lambda-${{ inputs.lambda_name }}-${{ inputs.environment }}" "${{ matrix.region }}"

      - name: Get image URI for this region
        id: image
        run: |
          bash scripts/ecr-copy-image-to-region.sh \
            "${{ needs.build.outputs.primary_region }}" \
            "${{ needs.build.outputs.image_uri_primary }}" \
            "${{ needs.build.outputs.tag }}" \
            "lambda-${{ inputs.lambda_name }}-${{ inputs.environment }}" \
            "${{ matrix.region }}" \
            "${{ vars.AWS_ACCOUNT_ID }}"

      - name: Build tags payload
        id: tags
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          REGION: ${{ matrix.region }}
          VERSION: ${{ needs.build.outputs.tag }}
          LANGUAGE: go
          SERVICE: ${{ inputs.lambda_name }}
          CONFIG_TAGS: ${{ steps.lambda-config.outputs.config_tags }}
        run: |
          DEFAULT_TAGS=$(jq -n --arg env "$ENVIRONMENT" --arg region "$REGION" --arg version "$VERSION" --arg language "$LANGUAGE" --arg service "$SERVICE" '{Environment:$env, Region:$region, Version:$version, Language:$language, Service:$service}')
          CONFIG_TAGS_JSON=$(echo "$CONFIG_TAGS" | jq -c '.' 2>/dev/null || echo "{}")
          MERGED=$(jq -c -s 'reduce .[] as $item ({}; . * $item)' <(echo "$DEFAULT_TAGS") <(echo "$CONFIG_TAGS_JSON"))
          echo "tags=$MERGED" >> $GITHUB_OUTPUT

      - name: Determine Lambda execution role ARN
        id: lambda-role
        run: |
          ROLE_ARN="${{ steps.lambda-config.outputs.role_arn }}"
          [ -z "$ROLE_ARN" ] && ROLE_ARN="${{ secrets.LAMBDA_EXECUTION_ROLE_ARN }}"
          [ -z "$ROLE_ARN" ] && ROLE_ARN="${{ secrets.AWS_ROLE_ARN }}"
          [ -z "$ROLE_ARN" ] && echo "::error::No Lambda execution role ARN found." && exit 1
          echo "role_arn=$ROLE_ARN" >> $GITHUB_OUTPUT

      - name: Deploy Lambda (image)
        uses: aws-actions/aws-lambda-deploy@v1.1.0
        with:
          function-name: "${{ steps.lambda-config.outputs.function_name }}-${{ inputs.environment }}"
          package-type: Image
          image-uri: ${{ steps.image.outputs.uri }}
          role: ${{ steps.lambda-role.outputs.role_arn }}
          function-description: ${{ steps.lambda-config.outputs.description }}
          timeout: ${{ steps.lambda-config.outputs.timeout }}
          memory-size: ${{ steps.lambda-config.outputs.memory_size }}
          ephemeral-storage: ${{ steps.lambda-config.outputs.ephemeral_storage }}
          architectures: ${{ steps.lambda-config.outputs.architectures }}
          environment: ${{ steps.lambda-config.outputs.env_vars }}
          vpc-config: ${{ steps.lambda-config.outputs.vpc_config }}
          dead-letter-config: ${{ steps.lambda-config.outputs.dead_letter_config }}
          kms-key-arn: ${{ steps.lambda-config.outputs.kms_key_arn }}
          tracing-config: ${{ steps.lambda-config.outputs.tracing_config }}
          file-system-configs: ${{ steps.lambda-config.outputs.file_system_configs }}
          image-config: ${{ steps.lambda-config.outputs.image_config }}
          snap-start: ${{ steps.lambda-config.outputs.snap_start }}
          logging-config: ${{ steps.lambda-config.outputs.logging_config }}
          code-signing-config-arn: ${{ steps.lambda-config.outputs.code_signing_config_arn }}
          publish: ${{ steps.lambda-config.outputs.publish }}
          tags: ${{ steps.tags.outputs.tags }}
